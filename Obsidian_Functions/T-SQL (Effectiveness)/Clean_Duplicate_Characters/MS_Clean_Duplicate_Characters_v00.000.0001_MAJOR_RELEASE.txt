--The following few blocks of code create a new function which is used later on in this query in order to remove multiple consecutive duplicate characters.
Declare @Create_Function_Command Nvarchar(Max);
Set @Create_Function_Command =
	N'Create Function dbo.Obsidian_Clean_Duplicate_Characters (@Data Nvarchar(Max), @Duplicate_Character Nvarchar(1))
Returns Nvarchar(Max)
With Schemabinding
AS
Begin

Set @Data = @Duplicate_Character + @Data

While Patindex(''%'' + @Duplicate_Character + @Duplicate_Character + ''%'',@Data) > 0
	Set @Data = Replace(@Data, @Duplicate_Character + @Duplicate_Character, @Duplicate_Character)

Return Right(@Data, (Len(@Data) - 1))

End';

If Not Exists (Select * From Sysobjects Where Name='Obsidian_Clean_Duplicate_Characters' and Xtype='FN') --Make sure this function is not in use for another proprietary technique outside the Obsidian repository.
Execute sp_executesql @Create_Function_Command;